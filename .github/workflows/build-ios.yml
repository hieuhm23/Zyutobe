name: Build iOS IPA (No Sign) - ZyTube

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-ios:
    name: Build Unsigned IPA
    runs-on: macos-latest
    
    steps:
      - name: üèó Checkout repository
        uses: actions/checkout@v4

      - name: üèó Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: üßπ Clean Cache
        run: |
          npm cache clean --force
          rm -rf node_modules
          rm -rf ios/Pods
          rm -rf ~/Library/Developer/Xcode/DerivedData

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üî® Prebuild iOS
        run: npx expo prebuild --platform ios --clean
        env:
          EAS_NO_VCS: 1
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: üíæ Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: üì¶ Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: üîß Install xcbeautify
        run: brew install xcbeautify

      - name: üöÄ Build iOS App (No Sign)
        run: |
          cd ios
          
          # T√¨m workspace v√† scheme t·ª± ƒë·ªông
          WORKSPACE=$(ls -d *.xcworkspace | head -1)
          SCHEME=$(echo $WORKSPACE | sed 's/.xcworkspace//')
          
          echo "Building $SCHEME in $WORKSPACE..."
          
          # T·∫Øt code signing v√† build v·ªõi log ƒë·∫πp
          set -o pipefail && xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            clean build | xcbeautify

      - name: üì¶ Pack to IPA
        run: |
          APP_PATH=$(find ios/build -name "*.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Error: Build failed (No .app found)."
            exit 1
          fi
          
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          zip -r ZyTube.ipa Payload
          
      - name: üì§ Upload IPA to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ZyTube-IPA
          path: ZyTube.ipa
          retention-days: 7
